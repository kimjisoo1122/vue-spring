<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.study.mapper.board.NoticeMapper">

    <!-- 공지글 알림을 등록합니다. -->
    <insert id="insertNoticeAlarm"
            parameterType="long">
        INSERT INTO notice_alarm
            (board_id)
        VALUES
            (#{boardId})
    </insert>

    <!-- 공지글 알림을 조회합니다.-->
    <select id="selectNoticeAlarm"
            parameterType="int"
            resultType="boardDto">
        SELECT
            '알림' AS category_name,
            IF (b.create_date >= DATE(NOW()) - INTERVAL #{newDay} DAY, TRUE, FALSE) AS new_status,
            <include refid="com.study.mapper.board.BoardMapper.selectBoard"/>
        FROM (SELECT board_id
              FROM notice_alarm
              ORDER BY create_date DESC
              LIMIT #{limit}) a
            JOIN board b ON b.board_id = a.board_id
            JOIN user u ON b.user_id = u.user_id
            JOIN category c ON b.category_id = c.category_id
        ORDER BY b.create_date DESC
    </select>

    <!-- 게시글번호로 공지사항 폼데이터를 조회합니다. -->
    <select id="selectNoticeForm"
            parameterType="long"
            resultType="boardForm">
        SELECT
        <include refid="com.study.mapper.board.BoardMapper.selectBoard"/>
        ,EXISTS (SELECT 1 FROM notice_alarm n WHERE n.board_id = b.board_id) AS checkAlarm
        FROM board b
        WHERE board_id = #{boardId}
    </select>

    <!-- 공지사항 알림을 지웁니다. -->
    <delete id="deleteNoticeAlarm"
            parameterType="long">
        DELETE
        FROM notice_alarm
        WHERE board_id = #{boardId}
    </delete>
</mapper>