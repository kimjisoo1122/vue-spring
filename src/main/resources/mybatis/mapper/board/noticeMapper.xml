<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.study.mapper.NoticeMapper">

    <!-- 공지글 알림을 등록합니다. -->
    <insert id="insertNoticeAlarm"
            parameterType="long">
        INSERT INTO notice_alarm
            (board_id)
        VALUES
            (#{boardId})
    </insert>

    <!-- 공지글 알림을 조회합니다.-->
    <select id="selectNoticeAlarm"
            parameterType="int"
            resultType="boardDto">
        SELECT
            <include refid="com.study.mapper.BoardMapper.selectBoard"/>
            ,'알림' AS category_name
        FROM (SELECT board_id
              FROM notice_alarm
              ORDER BY create_date DESC
              LIMIT #{limit}) a
            JOIN board b ON b.board_id = a.board_id
            JOIN user u ON b.user_id = u.user_id
            JOIN category c ON b.category_id = c.category_id
    </select>

    <!-- 게시글번호로 공지사항을 조회합니다. -->
    <select id="selectNoticeByBoardId"
            parameterType="long"
            resultType="boardForm">
        SELECT
        <include refid="com.study.mapper.BoardMapper.selectBoard"/>
        ,EXISTS (SELECT 1 FROM notice_alarm n WHERE n.board_id = b.board_id) AS checkAlarm
        FROM board b
        WHERE board_id = #{boardId}
    </select>

<!--    &lt;!&ndash; 게시글 검색조건 &ndash;&gt;-->
<!--    <sql id="whereSearchCondition">-->
<!--        <where>-->
<!--            <choose>-->
<!--                &lt;!&ndash; 검색기간이 존재하지 않으면 지난 1년을 기본으로 조회합니다. &ndash;&gt;-->
<!--                <when test="(fromDate != null &amp;&amp; fromDate !='') || (toDate != null &amp;&amp; toDate !='')">-->
<!--                    DATE_FORMAT(n.create_date, '%Y-%m-%d') BETWEEN #{fromDate} AND #{toDate}-->
<!--                </when>-->
<!--                <otherwise>-->
<!--                    DATE_FORMAT(n.create_date, '%Y-%m-%d')-->
<!--                    BETWEEN DATE_FORMAT(DATE_SUB(CURDATE(), INTERVAL 1 YEAR),'%Y-%m-%d')-->
<!--                    AND DATE_FORMAT(NOW(),'%Y-%m-%d')-->
<!--                </otherwise>-->
<!--            </choose>-->
<!--            <if test="searchCategory != null &amp;&amp; searchCategory != ''">-->
<!--                AND n.category_id = #{searchCategory}-->
<!--            </if>-->
<!--            <if test="search != null &amp;&amp; search != ''">-->
<!--                AND-->
<!--                (n.title LIKE CONCAT('%', #{search}, '%')-->
<!--                OR-->
<!--                n.content LIKE CONCAT('%', #{search}, '%'))-->
<!--            </if>-->
<!--        </where>-->
<!--    </sql>-->

</mapper>